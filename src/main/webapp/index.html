<!DOCTYPE html>
<!--
 - Syncnapsis Framework - Copyright (c) 2012-2014 ultimate
 - 
 - This program is free software; you can redistribute it and/or modify it under the terms of
 - the GNU General Public License as published by the Free Software Foundation; either version
 - 3 of the License, or any later version.
 - 
 - This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
 - without even the implied warranty of MECHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 - See the GNU General Public License for more details.
 - 
 - You should have received a copy of the GNU General Plublic License along with this program;
 - if not, see <http://www.gnu.org/licenses/>.
-->
<html lang="de">
	<meta charset="utf-8">
	<head>
		<script type="text/javascript" src="scripts/three.min-124.js"></script>
		<script type="text/javascript" src="scripts/stats.min.js"></script>
		<script type="text/javascript" src="scripts/Events.js"></script>		
		<script type="text/javascript" src="scripts/ColorModel.js"></script>	
		<script type="text/javascript" src="scripts/TextureModel.js"></script>		
		<script type="text/javascript" src="scripts/ViewUtil.js"></script>		
		<script type="text/javascript" src="scripts/View.js"></script>			
		<script type="text/javascript">
			var galaxies = {};
			var view;
		
			var camera, scene, renderer, raycaster, stats;
			var mesh,mesh2;			
			var mouse = { x: 0, y: 0 };	
			var activeSector = null;		
						
			document.addEventListener("DOMContentLoaded", function(){	
				init();
				animate();			
			}, false);	
			
			function onClick( event ) {
				// TODO move to view.js
				//event.preventDefault();
				console.log("click @ " + event.clientX + "|" + event.clientY);
				view.deselect(0);					
				activeSector = view.findSectorAt(event.clientX, event.clientY);					
				if(activeSector == null)
					view.camera.target.target = new THREE.Vector3(0,0,0);
				else
					view.camera.target.target = activeSector.coords.value;
				view.select(activeSector);
			};
		
			
			function init() {
				console.log("init");
			
				// init UI
				// add galaxies to select
				var select = document.getElementById("select_galaxy");
				for(var key in galaxies)
				{
					console.log("adding galaxy: '" + key + "'");
					var option = document.createElement("option");
					option.value = key;
					var text = document.createTextNode(key);
					option.appendChild(text);
					select.appendChild(option);
				}
				// add color & texture choices				
				showOptions();
				
				view = new View(document.getElementById("view"));
				
				selectGalaxy();

				//projector = new THREE.Projector(); // TODO changed as of r84 or so
				raycaster = new THREE.Raycaster();	

				stats = new Stats();
				document.getElementById("stats").appendChild( stats.domElement );	
			};	
			
			var selectionScreenSize;
			
			function animate() {				
				requestAnimationFrame( animate );
				stats.update();	
				view.render();
			}	
			
			/******************
			 * new
			******************/
			
			var galaxy;
			var planes = {};
			
			createPlanes = function(galaxyInfo) {			
				var count = 9;
				var geometry;
				var material;
				var mesh;			
				// XY
				if(planes.xy == null)
				{
					planes.xy = new Array();
					geometry = new THREE.PlaneGeometry(galaxyInfo.boundX*2, galaxyInfo.boundY*2);					
					material = view.materials.planeT.clone();
					material.color = new THREE.Color(0x00ff99);
					for(var i = 0; i < count; i++) {
						mesh = new THREE.Mesh(geometry, material);
						scene.add(mesh);
						planes.xy.push(mesh);
					};	
				}
				for(var i = 0; i < count; i++) {
					planes.xy[i].position.z = galaxyInfo.boundZ/count * 2 * (i+0.5) - galaxyInfo.boundZ;
					planes.xy[i].rotation.z = Math.PI / 2;
				};			
				// XZ				
				if(planes.xz == null)
				{
					planes.xz = new Array();
					geometry = new THREE.PlaneGeometry(galaxyInfo.boundX*2, galaxyInfo.boundZ*2);				
					material = view.materials.planeT.clone();
					material.color = new THREE.Color(0x9900ff);
					for(var i = 0; i < count; i++) {
						mesh = new THREE.Mesh(geometry, material);
						scene.add(mesh);
						planes.xz.push(mesh);
					};	
				}
				for(var i = 0; i < count; i++) {
					planes.xz[i].position.y = galaxyInfo.boundY/count * 2 * (i+0.5) - galaxyInfo.boundY;
					planes.xz[i].rotation.x = Math.PI / 2;
				};		
				// YZ				
				if(planes.yz == null)
				{
					planes.yz = new Array();
					geometry = new THREE.PlaneGeometry(galaxyInfo.boundZ*2, galaxyInfo.boundY*2);				
					material = view.materials.planeT.clone();
					material.color = new THREE.Color(0xff9900);
					for(var i = 0; i < count; i++) {
						mesh = new THREE.Mesh(geometry, material);
						scene.add(mesh);
						planes.yz.push(mesh);
					};	
				}
				for(var i = 0; i < count; i++) {
					planes.yz[i].position.x = galaxyInfo.boundX/count * 2 * (i+0.5) - galaxyInfo.boundX;
					planes.yz[i].rotation.y = Math.PI / 2;
				};
			};	
			
			updateStars = function(firstCall)
			{
				console.log("update stars");
				var factor = 0.6;				
				var diffTreshold;
				if(galaxy.animation == -1)
					diffTreshold = 10;
				else
					diffTreshold = 1;
				
				var inMotion = 0;
				var diff;
				var target;
				for(i = 0; i < galaxy.particles.vertices.length; i++)
				{
					if(galaxy.animation == -1)
						target = new THREE.Vector3(0,0,0);
					else
						target = galaxy.particles.vertices[i].target;
						
					// x
					diff = Math.abs(target.x - galaxy.particles.vertices[i].x);
					if(diff < diffTreshold && diff > 0)
					{
						//galaxy.particles.vertices[i].x = target.x;
					}
					else if(diff > 0)
					{
						galaxy.particles.vertices[i].x = target.x - (target.x - galaxy.particles.vertices[i].x)*factor;
						inMotion++;
					}
					// y
					diff = Math.abs(target.y - galaxy.particles.vertices[i].y);
					if(diff < diffTreshold && diff > 0)
					{
						//galaxy.particles.vertices[i].y = target.y;
					}
					else if(diff > 0)
					{
						galaxy.particles.vertices[i].y = target.y - (target.y - galaxy.particles.vertices[i].y)*factor;
						inMotion++;
					}
					// z
					diff = Math.abs(target.z - galaxy.particles.vertices[i].z);
					if(diff < diffTreshold && diff > 0)
					{
						//galaxy.particles.vertices[i].z = target.z;
					}
					else if(diff > 0)
					{
						galaxy.particles.vertices[i].z = target.z - (target.z - galaxy.particles.vertices[i].z)*factor;
						inMotion++;
					}
				}
				
				if((inMotion == 0 && galaxy.animation == -1) || (galaxy.animation == 1 && firstCall == true))			
				{				
					console.log("animation -1 done!");
					galaxy.animation = 1;		
					inMotion = 1;
					
					var colormodel = colormodels[checkedRadioButton("colormodel")];
					for(i = 0; i < galaxy.particles.vertices.length; i++)
					{
						target = galaxy.particles.vertices[i].target;
						if(target.x == 0 && target.y == 0 && target.z == 0)
						{
							galaxy.sizes[i] = 0;
							
							galaxy.colors[i].radius = 0;
							galaxy.colors[i].radius2 = 0;
						}
						else
						{
							galaxy.colors[i].radius = galaxy.colors[i].radius_tmp;
							galaxy.colors[i].radius2 = galaxy.colors[i].radius2_tmp;
							galaxy.colors[i].calculateRGB(colormodel);
						}
					}					
					view.shaders.attributes.size.needsUpdate = true;	
					view.shaders.attributes.customColor.needsUpdate = true;	
				}
				
				//console.log("stars updated: " + inMotion);
				if(inMotion > 0)
				{
					galaxy.particleSystem.geometry.verticesNeedUpdate = true;
					setTimeout(updateStars, 100);
				}
			}
			
			updatePlanes = function()
			{
				if(view.planes.xy)
					view.planes.xy.material.visible = document.getElementById("planesXY").checked;
				if(view.planes.xz)
					view.planes.xz.material.visible = document.getElementById("planesXZ").checked;
				if(view.planes.yz)
					view.planes.yz.material.visible = document.getElementById("planesYZ").checked;
			};
			
			updateRotation = function()
			{
				if(document.getElementById("rotateCW").checked)
					view.camera.rotate(1);
				else if(document.getElementById("rotateCCW").checked)
					view.camera.rotate(-1);
				else
					view.camera.rotate(0);
			};
			
			selectGalaxy = function()
			{
				sectors = null;
				var selection = document.getElementById("select_galaxy").value;
				console.log("loading galaxy: " + selection + " (stars: " + galaxies[selection].length + ")");
				sectors = galaxies[selection];
				/*
				var iframe = document.getElementById(document.getElementById("select_galaxy").value);
				console.log("loading galaxy: " + iframe.src);
				if(iframe.contentWindow.document.body != null)
					doSelectGalaxy();
				else
					iframe.onload = doSelectGalaxy;				
			};
			
			doSelectGalaxy = function()
			{
				var script = document.getElementById(document.getElementById("select_galaxy").value);
				var str = script.contentWindow.document.body.innerHTML;
				str = str.substring(5,str.length-6);
				//alert(str);
				console.log("parsing sectors...");
				window.eval(str);
				console.log("sectors parsed: " + (sectors == null ? "null" : sectors.length));
				*/
				view.load(sectors,1);
				updatePlanes();
				updateColors();
				updateRotation();
			};
			
			updateColors = function()
			{
				var colormodel = ViewUtil.ColorModel[checkedRadioButton("colormodel")];
				console.log("updateColors: " + colormodel.name);
				for(i = 0; i < view.galaxy.systems.length; i++)
				{
					view.galaxy.systems[i].colorModel = colormodel;
					view.galaxy.systems[i].updateColor();
				}
				view.galaxy.systemGeometry.getAttribute("color").needsUpdate = true;
				//view.galaxy.systemShader.attributes.customColor.needsUpdate = true;
			};
			
			updateTextures = function()
			{
				var colormodel = ViewUtil.ColorModel[checkedRadioButton("texturemodel")];
				console.log("updateTextures: " + texturemodel.name);
				/*
				for(i = 0; i < view.galaxy.systems.length; i++)
				{
					view.galaxy.systems[i].colorModel = colormodel;
					view.galaxy.systems[i].updateColor();
				}
				view.galaxy.systemGeometry.getAttribute("color").needsUpdate = true;
				//view.galaxy.systemShader.attributes.customColor.needsUpdate = true;
				*/
			};
						
			var debugRGB = false;
						
			showOptions = function()
			{
				var cmDiv = document.getElementById("colormodels");
				for(cm in ViewUtil.ColorModel)
				{	
					if(typeof ViewUtil.ColorModel[cm] != "object")
						continue;
					var colormodel = ViewUtil.ColorModel[cm];
					ViewUtil.ColorModel.createRadioButton(colormodel, cmDiv);
				}
				
				var tmDiv = document.getElementById("texturemodels");
				for(tm in ViewUtil.TextureModel)
				{	
					if(typeof ViewUtil.TextureModel[tm] != "object")
						continue;
					var texturemodel = ViewUtil.TextureModel[tm];
					ViewUtil.TextureModel.createRadioButton(texturemodel, tmDiv);
				}
			};	
			
			checkedRadioButton = function(sGroupName)
			{   
				var group = document.getElementsByName(sGroupName);

				for ( var i = 0; i < group.length; i++) {
					if (group.item(i).checked) {
						return group.item(i).value;
					} else if (group[0].type !== 'radio') {
						//if you find any in the group not a radio button return null
						return null;
					}
				}
			};
		</script>

		<style type="text/css">
		<!--		
			#testDiv {		
				position:absolute;
				width:20px;
				height:20px;
				border:solid 3px #09f;
				color:#09f;
				font-family:arial,sans;
				border-radius:50px;		
			}
			body {
				padding: 0px;
				margin: 0px;
				overflow: hidden;
			}
			#control {
				position: absolute;
				top: 0px;
				left: 0px;
				width: 350px;
				height: 100%;
				background: #111111;
				color: #AAAAAA;
				border: 1px solid #888888;
			}
			#stats div {
				right: 0px;
				left: auto !important;
			}			
			#view {
				position: absolute;
				left: 0px;
				top: 0px;
				right: 0px;
				bottom: 0px;
				width: 100%;
				height: 100%;
			}
			.colormodel {
				height: 20px;
			}
			.colorbar {
				width: 200px;
				height: 20px;
				position: relative;
				left: 30px;
				top: -20px;
				margin-bottom: -22px;
				border: 1px solid #000000;
			}
			.colorbar_description {
				position: relative;
				left: 240px;
				top: -19px;
				margin-bottom: -22px;
			}
			.model {
				height: 20px;
			}
			.model canvas {
				/*height: 20px;*/
				position: relative;
				top: -16px;
				left: 5px;
				margin-bottom: -22px;
				border: 1px solid #000000;
			}
			.model.texture canvas {
				/*width: 20px;*/ 
			}
			.model .description {
				margin-left: 10px;
			}
		-->
		</style>		
	</head>
	<body>
		<div id="view">
		</div>
		<div id="control">
			Show-Planes?<br>
			<input type="checkbox" id="planesXY" onchange="updatePlanes();"/> XY &nbsp;
			<input type="checkbox" id="planesXZ" onchange="updatePlanes();"/> XZ &nbsp;
			<input type="checkbox" id="planesYZ" onchange="updatePlanes();"/> YZ &nbsp;
			<br>
			Rotate?<br>
			<input type="radio" id="rotateCW"  name="rotation" onchange="updateRotation();"/> CW &nbsp;
			<input type="radio" id="rotateCCW" name="rotation" onchange="updateRotation();" checked="checked"/> CCW &nbsp;
			<input type="radio" id="rotateNot" name="rotation" onchange="updateRotation();"/> None &nbsp;
			<br>
			Galaxy?<br>
			&nbsp;<select id="select_galaxy" size="1" onchange="selectGalaxy();"></select><br>
			Colormodel?<br>
			<div id="colormodels"><!-- generated by JS --></div>
			Texture?<br>
			<div id="texturemodels"><!-- generated by JS --></div>
		</div>
		<div style="display: none;">
			<script type="text/javascript" src="sectors/sectors-0.1-medium.js"></script>
			<script type="text/javascript" src="sectors/sectors-0.1-large.js"></script>
			<script type="text/javascript" src="sectors/sectors-spiral_3_arms.js"></script>
			<script type="text/javascript" src="sectors/sectors-spiral_barred.js"></script>
			<script type="text/javascript" src="sectors/sectors-ellipsis.js"></script>
			<script type="text/javascript" src="sectors/sectors-ellipsis_small.js"></script>
			<script type="text/javascript" src="sectors/sectors-rings_5.js"></script>
			<script type="text/javascript" src="sectors/sectors-arcs.js"></script>
			<script type="text/javascript" src="sectors/sectors-arcs_spiral.js"></script>
			<script type="text/javascript" src="sectors/sectors-test.js"></script>
		</div>
		<div id="stats">
		</div>
	</body>
</html>